name: VisualDiff


on: 
  push:
    branches:
      - main
  pull_request:

jobs:
    GetPreMergeImages:
        name: Get images from target branch
        runs-on: ubuntu-latest

        steps:
          - name: Checkout code
            uses: actions/checkout@v3
            with: 
                ref: ${{ github.base_ref }}

          - name: Set up Python
            uses: actions/setup-python@v4
            with:
                python-version: 3.9

          - name: Install requirements
            run: |
                python -m pip install --upgrade pip
                bash setupDevEnvironmentUbuntu.sh

          - name: GetImages
            uses: GabrielBB/xvfb-action@v1
            with:
                run: bash runGetImages.sh

          - name: Save images
            uses: actions/upload-artifact@v4
            with:
                name: pre-merge-images
                path: imagesOutput/

    GetPostMergeImages:
        name: Get images from proposed change
        runs-on: ubuntu-latest

        steps:
          - name: Checkout code
            uses: actions/checkout@v3
            with: 
                ref: ${{ github.head_ref }}

          - name: Set up Python
            uses: actions/setup-python@v4
            with:
                python-version: 3.9

          - name: Install requirements
            run: |
                python -m pip install --upgrade pip
                bash setupDevEnvironmentUbuntu.sh

          - name: GetImages
            uses: GabrielBB/xvfb-action@v1
            with:
                run: bash runGetImages.sh

          - name: Save images
            uses: actions/upload-artifact@v4
            with:
                path: imagesOutput/adminScreen.png

    CompareImages:
        name: Compare images
        runs-on: ubuntu-latest
        needs: [GetPostMergeImages]

        steps:
          - name: Diff snapshots
            id: visual-snapshots-diff
            uses: getsentry/action-visual-snapshot@v1
            with:
              snapshot-path: imagesOutput/adminScreen.png
              githubToken: ${{ secrets.GITHUB_TOKEN }}
